================================================================================
  RUMI PROTOCOL â€” MULTI-COLLATERAL REFACTOR TEST REPORT
================================================================================

Date:    2026-02-23 07:27:39 UTC
Branch:  feature/multi-collateral-refactor
Commit:  5840ff4 (test: add 28 multi-collateral unit tests + fix redeem_on_vaults debug_assert)
Rust:    rustc 1.92.0 (ded5c06cf 2025-12-08)

================================================================================
  SUMMARY
================================================================================

  Unit tests (tests.rs):         40 passed, 0 failed, 5 ignored (pre-existing)
  Library tests:                  4 passed, 0 failed
  Candid compatibility:           1 passed
  PocketIC integration:          21 passed, 0 failed
  WASM build:                    OK (3.04 MB)

  TOTAL:                         66 passed, 0 failed

================================================================================
  TEST BREAKDOWN
================================================================================

  MULTI-COLLATERAL UNIT TESTS (28 new):
    Decimal precision math (8/18/6 decimals)           4 tests
    Per-collateral CR calculation                      3 tests
    Per-collateral ratio/fee lookups                   3 tests
    Cross-collateral redemption isolation              2 tests
    Liquidation with non-ICP collateral                2 tests
    Mixed-collateral TCR                               2 tests
    CollateralStatus enforcement matrix                1 test
    Legacy backward compat (anonymous->ICP)            2 tests
    PendingMarginTransfer carries collateral_type      1 test
    Price update isolation                             2 tests
    Per-collateral fee lookups                         2 tests
    Tiny amounts / zero price edge cases               4 tests

  POCKET-IC INTEGRATION TESTS (21 total, 14 new):
    Original ICP-only tests:                           7 tests
    Multi-collateral flow tests:                       6 tests
      - add_collateral_token registration
      - open_vault with ckETH (18 decimals)
      - borrow against ckETH vault
      - ckETH vault full lifecycle (open->borrow->repay->close)
      - CollateralStatus::Paused enforcement
      - CollateralStatus::Frozen enforcement
    Upgrade safety tests:                              4 tests
      - Upgrade with empty state
      - Upgrade preserves ICP vaults + post-upgrade operations
      - Upgrade preserves multi-collateral state (ICP + ckETH)
      - Double upgrade stability
    Edge case tests:                                   4 tests
      - Unregistered collateral type rejected
      - Non-developer add_collateral rejected
      - ICP and ckETH vaults coexist independently
      - None collateral_type defaults to ICP

  BUGS FOUND AND FIXED DURING TESTING:
    [state.rs] redeem_on_vaults: missing icusd_amount_to_convert = 0
    before break in 'convert everything' branch. Caused debug_assert
    failure in test builds. Fixed in commit 5840ff4.

================================================================================
  RUN COMMANDS
================================================================================

  # Unit tests (instant)
  cargo test -p rumi_protocol_backend --test tests

  # PocketIC integration tests (~40s)
  POCKET_IC_BIN=./pocket-ic cargo test -p rumi_protocol_backend --test pocket_ic_tests

  # Library tests
  cargo test -p rumi_protocol_backend --lib

  # All tests
  POCKET_IC_BIN=./pocket-ic cargo test -p rumi_protocol_backend

  # WASM build
  cargo build --target wasm32-unknown-unknown --release -p rumi_protocol_backend

================================================================================
